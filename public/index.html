<!DOCTYPE html>
<html lang=es>
<head>
<meta charset="UTF_8">
<title>minicomms</title>
<style>

</style>
<script>

class WSClient{
    constructor(ws){
        this.ws = ws;
        this.priv_id = self.crypto.randomUUID();
        this._update_ready_state();
        ws.addEventListener('open', (ev)=>{this.register()});

        ws.addEventListener('message', (ev)=>{this.on_message(ev.data)});

        ws.addEventListener('error', (ev) =>{
            this._update_ready_state();
            console.log(`error: ${JSON.stringify(ev)}`);
        });
        ws.addEventListener('close', (ev) =>{
            this._update_ready_state();
            console.log(`close: ${JSON.stringify(ev)}`);
        });
    }

    _msg(cmd, data={}) {
        this.ws.send(JSON.stringify({
            i: this.priv_id,
            c: cmd,
            d: data
        }));
    }

    _update_ready_state() {
        document.getElementById(
            'div_ready_state'
        ).innerHTML = `ready_state = ${this.ws.readyState}`;
    }

    register() {
        this._update_ready_state();
        this._msg('register');
    }

    pinga() {
        if (this.ws.readyState == this.ws.OPEN){
            setTimeout(()=>{this.pinga()}, 100);
            this.last_ping = performance.now();
            this._msg('ping', {t: this.last_ping});
        }
    }

    on_message(raw_msg) {
        let msg = JSON.parse(raw_msg);
        if (msg.c=='public_id')
            this.on_public_id(msg.d);
        else if (msg.c=='pong')
            this.on_pong(msg.d);
        else
            console.log(`bad message ${raw_msg}`);
    }

    on_public_id(data) {
        this.public_id = data;
        document.getElementById(
            'div_public_id'
        ).innerHTML = `public_id = ${this.public_id}`;
        this.pinga();
    }

    on_pong(data) {
        const rtt = performance.now() - this.last_ping;
        document.getElementById(
            'div_rtt'
        ).innerHTML = `rtt = ${rtt.toFixed(2)}`;
    }
}

function main(){
    const ws = new WebSocket(`ws://${window.location.host}/ws`);
    const client = new WSClient(ws);
}

window.onload = main;
</script>
</head>
<body>
<h2>minicomms client test</h2>
<ul>
    <li><div id=div_ready_state>ready_state = </div></li>
    <li><div id=div_public_id>public_id = </div></li>
    <li><div id=div_rtt>rtt= </div></li>
</ul>
</body>
</html>