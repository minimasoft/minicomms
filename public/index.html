<!DOCTYPE html>
<html lang=es>
<head>
<meta charset="UTF_8">
<title>minicomms</title>
<style>

</style>
<script>

class WSClient{
    constructor(ws){
        this.ws = ws;
        this.priv_id = self.crypto.randomUUID();

        ws.addEventListener('open', (ev)=>{this.register()});

        ws.addEventListener('message', (ev)=>{this.on_message(ev.data)});

        ws.addEventListener('error', (ev) =>{
            console.log(`error: ${JSON.stringify(ev)}`);
        });
        ws.addEventListener('close', (ev) =>{
            console.log(`close: ${JSON.stringify(ev)}`);
        });
    }

    _msg(cmd, data={}) {
        this.ws.send(JSON.stringify({
            i: this.priv_id,
            c: cmd,
            d: data
        }));
    }

    register() {
        this._msg('register');
    }

    pinga() {
        if (this.ws.readyState == this.ws.OPEN){
            setTimeout(()=>{this.pinga()}, 100);
            this.last_ping = performance.now();
            this._msg('ping', {t: this.last_ping});
        }
    }

    on_message(raw_msg) {
        let msg = JSON.parse(raw_msg);
        if (msg.c=='public_id')
            this.on_public_id(msg.d);
        else if (msg.c=='pong')
            this.on_pong(msg.d);
        else
            console.log(`bad message ${raw_msg}`);
    }

    on_public_id(data) {
        this.public_id = data;
        console.log(`this.public_id=${this.public_id}`);
        this.pinga();
    }

    on_pong(data) {
        const rtt = performance.now() - this.last_ping;
        console.log(`rtt=${rtt.toFixed(2)}`);
    }
}

function main(){
    const ws = new WebSocket(`ws://${window.location.host}/ws`);
    const client = new WSClient(ws);
}

window.onload = main;
</script>
</head>
<body>
<h1>Hello</h1>
</body>
</html>